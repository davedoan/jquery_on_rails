module JQueryOnRails
  module Helpers
    module JQueryUiHelper
      unless const_defined? :RENAME_EFFECTS
        RENAME_EFFECTS = { :appear=>'fadeIn', :fade=>'fadeOut' }
      end
      
      # Generates jQuery UI effects.  This expands upon the core jQuery 1.4 effects
      # that are generated by JQueryHelper#visual_effect
      def visual_effect(name, element_id = false, js_options = {})
        element = element_id ? ActiveSupport::JSON.encode("##{element_id}") : "element"
        element, before, after = "jQuery(#{element})", '', ''
        
        # [:endcolor, :direction, :startcolor, :scaleMode, :restorecolor]
        before = ".css('background-color', '#{js_options.delete(:startcolor)}')" if js_options[:startcolor]
        after = "animate('background-color', '#{js_options.delete(:endcolor)})." if js_options[:endcolor]
        js_options[:direction] = "'#{js_options[:direction]}'" if js_options.include? :direction
          
        js_options = (options_for_javascript js_options unless js_options.empty?)
        case name = name.to_sym
        when :toggle_appear
          "(function(state){ return (function() { state=!state; return #{after}#{element}['fade'+(state?'In':'Out')](#{js_options}); })(); })(#{element}#{before}.css('visiblity')!='hidden');"
        else
          if name.to_s.start_with? 'toggle_'
            js_options = "'#{name.to_s[7..-1].to_sym}'#{','+js_options if js_options.present?}"
            name = 'toggle'
          elsif RENAME_EFFECTS.include? name
            name = RENAME_EFFECTS[name]
          else
	          name = name.to_s.camelize(:lower)
	          if name.end_with? 'Down'
	            mode, name = 'show', name[0..-5]
	          elsif name.end_with? 'Up'
	            mode, name = 'hide', name[0..-3]
	          end
	          if js_options.nil? then js_options = "{mode:'#{mode}'}" else
              js_options = "{mode:'#{mode}',#{js_options[1..-2]}}"
	          end
	        end
          "#{element}#{before}.#{after}#{name}(#{js_options});"
        end
      end

    end
  end
end